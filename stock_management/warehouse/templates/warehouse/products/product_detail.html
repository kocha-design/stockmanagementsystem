{% extends 'warehouse/base.html' %}
{% load dict_extras %}

{% block title %}{{ product.name }} - Stock Management{% endblock %}

{% block page_title %}{{ product.name }}{% endblock %}

{% block page_actions %}
<a href="{% url 'product_list' %}" class="btn btn-sm btn-secondary">
    <i class="fas fa-arrow-left"></i> Rudi
</a>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Product Info -->
    <div class="col-md-4">
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> Maelezo ya Bidhaa</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <th>Jina:</th>
                        <td>{{ product.name }}</td>
                    </tr>
                    <tr>
                        <th>SKU:</th>
                        <td><code>{{ product.sku }}</code></td>
                    </tr>
                    <tr>
                        <th>Kategoria:</th>
                        <td>{{ product.category.name|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>Bei:</th>
                        <td>TZS {{ product.unit_price|floatformat:0 }}</td>
                    </tr>
                    <tr>
                        <th>Jumla Stock:</th>
                        <td>
                            <span class="badge bg-info">{{ total_stock }}</span>
                        </td>
                    </tr>
                    <tr>
                        <th>Reorder Level:</th>
                        <td>{{ product.reorder_level }}</td>
                    </tr>
                </table>
                {% if product.description %}
                <div class="mt-3">
                    <h6>Maelezo:</h6>
                    <p class="text-muted">{{ product.description }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Stock by Warehouse -->
    <div class="col-md-8">
        <div class="card shadow mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-warehouse"></i> Stock kwa Kila Ghala</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead class="table-success">
                            <tr>
                                <th>Ghala</th>
                                <th>Eneo</th>
                                <th>Stock Iliyopo</th>
                                <th>Hali</th>
                                <th>Vitendo</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in stock_by_warehouse %}
                            <tr>
                                <td>
                                    <i class="fas fa-warehouse"></i> 
                                    {{ item.warehouse.name }}
                                </td>
                                <td>{{ item.warehouse.location|default:"-" }}</td>
                                <td class="text-center fw-bold 
                                    {% if item.current_stock <= 0 %}text-danger
                                    {% elif item.current_stock <= product.reorder_level %}text-warning
                                    {% else %}text-success{% endif %}">
                                    {{ item.current_stock }}
                                </td>
                                <td>
                                    {% if item.current_stock <= 0 %}
                                    <span class="badge bg-danger">Hakuna Stock</span>
                                    {% elif item.current_stock <= product.reorder_level %}
                                    <span class="badge bg-warning">Stock Ndogo</span>
                                    {% else %}
                                    <span class="badge bg-success">Ipo</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="/admin/warehouse/stockin/add/?product={{ product.id }}&warehouse={{ item.warehouse.id }}" 
                                       class="btn btn-sm btn-success">
                                        <i class="fas fa-plus"></i> Ingiza
                                    </a>
                                    <a href="/admin/warehouse/stockout/add/?product={{ product.id }}&warehouse={{ item.warehouse.id }}" 
                                       class="btn btn-sm btn-danger">
                                        <i class="fas fa-minus"></i> Toa
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">
                                    Hakuna maghala yaliyosajiliwa
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Transaction History -->
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-history"></i> Historia ya Manunuzi</h5>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="transactionTab">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#stockin">
                            Maingizo ({{ stockins|length }})
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#stockout">
                            Matoleo ({{ stockouts|length }})
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content mt-3">
                    <div class="tab-pane fade show active" id="stockin">
                        <div class="table-responsive">
                            <table class="table table-sm table-success">
                                <thead>
                                    <tr>
                                        <th>Tarehe</th>
                                        <th>Ghala</th>
                                        <th>Idadi</th>
                                        <th>Mtoaji</th>
                                        <th>Namba</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for stockin in stockins %}
                                    <tr>
                                        <td>{{ stockin.date_received|date:"d/m/Y H:i" }}</td>
                                        <td>{{ stockin.warehouse.name }}</td>
                                        <td class="text-success fw-bold">+{{ stockin.quantity }}</td>
                                        <td>{{ stockin.supplier }}</td>
                                        <td><code>{{ stockin.reference_no }}</code></td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            Hakuna maingizo ya stock
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="stockout">
                        <div class="table-responsive">
                            <table class="table table-sm table-danger">
                                <thead>
                                    <tr>
                                        <th>Tarehe</th>
                                        <th>Ghala</th>
                                        <th>Idadi</th>
                                        <th>Mnunuzi</th>
                                        <th>Namba</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for stockout in stockouts %}
                                    <tr>
                                        <td>{{ stockout.date_issued|date:"d/m/Y H:i" }}</td>
                                        <td>{{ stockout.warehouse.name }}</td>
                                        <td class="text-danger fw-bold">-{{ stockout.quantity }}</td>
                                        <td>{{ stockout.customer }}</td>
                                        <td><code>{{ stockout.reference_no }}</code></td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            Hakuna matoleo ya stock
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}